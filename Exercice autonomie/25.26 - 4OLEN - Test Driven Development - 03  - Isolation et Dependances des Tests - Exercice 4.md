
# Exercices TDD : Stubs, Mocks et Faker

## Exercice 1 : Système de Gestion de Réservations d'Hôtel (Intermédiaire)

### Objectif
Comprendre la différence entre **Stubs**, **Mocks** et **Fakes**, et utiliser **Faker** pour générer des données de test réalistes.

### Description
Créez un système de réservation d'hôtel qui interagit avec plusieurs services externes : base de données, service de paiement, service d'email, et service de disponibilité des chambres.

### Architecture

```python
# Services externes (à stubber/mocker)
- HotelDatabase : stockage des réservations
- PaymentGateway : traitement des paiements
- EmailService : envoi de confirmations
- RoomAvailabilityService : vérification disponibilité temps réel
- PricingService : calcul des prix (avec promotions)
- LoyaltyService : gestion des points de fidélité

# Service principal
- HotelReservationService : orchestrateur
```

### Fonctionnalités à implémenter

1. **Vérifier la disponibilité d'une chambre**
   - Appel au RoomAvailabilityService
   - Gestion des dates (check-in/check-out)
   - Différents types de chambres

2. **Créer une réservation**
   - Vérifier disponibilité
   - Calculer le prix total
   - Traiter le paiement
   - Sauvegarder la réservation
   - Envoyer email de confirmation
   - Créditer points de fidélité

3. **Annuler une réservation**
   - Rembourser selon politique d'annulation
   - Mettre à jour la disponibilité
   - Envoyer email d'annulation

4. **Modifier une réservation**
   - Vérifier nouvelle disponibilité
   - Recalculer prix
   - Gérer différence de prix

### Différences entre Stub, Mock et Fake

**STUB** : Retourne des données préprogrammées
```python
# Utiliser pour RoomAvailabilityService, PricingService
# On veut juste des réponses cohérentes, pas tester les interactions
```

**MOCK** : Vérifie les interactions (appels, paramètres)
```python
# Utiliser pour EmailService, LoyaltyService
# On veut vérifier QUE les emails sont envoyés avec les bons paramètres
```

**FAKE** : Implémentation simplifiée mais fonctionnelle
```python
# Utiliser pour HotelDatabase
# Une vraie base en mémoire pour tester la logique
```

### Tests à écrire (minimum 25)

#### Tests avec STUBS
1. **RoomAvailabilityService**
   ```python
   test_disponibilite_chambre_simple_disponible()
   test_disponibilite_chambre_occupee()
   test_disponibilite_avec_dates_invalides()
   test_disponibilite_chambre_type_specifique()
   test_service_disponibilite_timeout()
   ```

2. **PricingService**
   ```python
   test_calcul_prix_sans_promotion()
   test_calcul_prix_avec_promotion_pourcentage()
   test_calcul_prix_weekend_surcharge()
   test_calcul_prix_sejour_longue_duree()
   ```

#### Tests avec MOCKS
3. **EmailService**
   ```python
   test_email_confirmation_envoye_avec_bons_parametres()
   test_email_annulation_envoye()
   test_email_non_envoye_si_paiement_echoue()
   test_email_contient_details_reservation()
   test_nombre_emails_envoyes_exact()
   ```

4. **LoyaltyService**
   ```python
   test_points_credites_apres_reservation()
   test_points_credites_avec_bon_montant()
   test_points_non_credites_si_reservation_echoue()
   test_verification_membre_premium()
   ```

5. **PaymentGateway**
   ```python
   test_paiement_appele_avec_bon_montant()
   test_paiement_appele_une_seule_fois()
   test_details_paiement_corrects()
   ```

#### Tests avec FAKES
6. **HotelDatabase (Fake)**
   ```python
   test_sauvegarde_reservation_dans_db_fake()
   test_recuperation_reservation_par_id()
   test_mise_a_jour_reservation()
   test_suppression_reservation()
   test_recherche_reservations_par_date()
   ```

#### Tests d'intégration avec Faker
7. **Scénarios complets avec données générées**
   ```python
   test_reservation_complete_avec_donnees_faker()
   test_100_reservations_aleatoires_differentes()
   test_annulation_avec_donnees_realistes()
   test_modification_avec_nouvelles_dates()
   ```

### Exemples de tests attendus

#### Exemple 1 : Test avec Stub
```python
def test_verification_disponibilite_chambre_disponible():
    # Arrange
    stub_availability = StubRoomAvailabilityService()
    stub_availability.set_available(True)  # Stub retourne toujours True
    
    service = HotelReservationService(
        availability_service=stub_availability
    )
    
    # Act
    is_available = service.check_availability('ROOM-101', check_in, check_out)
    
    # Assert
    assert is_available == True
```

#### Exemple 2 : Test avec Mock
```python
def test_email_confirmation_envoye_avec_details():
    # Arrange
    mock_email = Mock(spec=EmailService)
    service = HotelReservationService(email_service=mock_email)
    
    # Act
    reservation = service.create_reservation(customer, room, dates)
    
    # Assert
    mock_email.send_confirmation.assert_called_once()
    call_args = mock_email.send_confirmation.call_args
    assert call_args[0][0] == customer.email  # Premier argument
    assert 'ROOM-101' in call_args[1]['body']  # Dans le corps
```

#### Exemple 3 : Test avec Fake
```python
def test_sauvegarde_et_recuperation_reservation():
    # Arrange
    fake_db = FakeHotelDatabase()  # Base en mémoire
    service = HotelReservationService(database=fake_db)
    
    # Act
    reservation = service.create_reservation(customer, room, dates)
    retrieved = service.get_reservation(reservation.id)
    
    # Assert
    assert retrieved.id == reservation.id
    assert retrieved.customer_name == customer.name
```

#### Exemple 4 : Test avec Faker (données générées)
```python
def test_creation_reservation_avec_donnees_reelles():
    # Arrange
    fake = Faker('fr_FR')
    
    # Générer 10 clients différents
    for i in range(10):
        customer = {
            'name': fake.name(),
            'email': fake.email(),
            'phone': fake.phone_number()
        }
        
        check_in = fake.date_between(start_date='+1d', end_date='+30d')
        nights = fake.random_int(min=1, max=7)
        check_out = check_in + timedelta(days=nights)
        
        # Act
        reservation = service.create_reservation(customer, 'ROOM-101', 
                                                 check_in, check_out)
        
        # Assert
        assert reservation is not None
        assert reservation.customer_email == customer['email']
```