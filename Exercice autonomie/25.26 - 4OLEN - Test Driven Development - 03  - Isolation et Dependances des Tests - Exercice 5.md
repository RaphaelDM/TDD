## Exercice 2 : Plateforme E-Commerce avec Inventaire et Logistique (Avancé)

### Objectif
Maîtriser l'utilisation combinée de Stubs, Mocks, Spies et Faker dans un contexte complexe avec transactions distribuées.

### Description
Créez une plateforme e-commerce complète avec gestion d'inventaire, commandes, paiements, expédition et notifications. Le système doit gérer des transactions distribuées et des rollbacks.

### Architecture Microservices

```python
# Services externes
- InventoryService : gestion stock (plusieurs entrepôts)
- PaymentProcessor : traitement paiements (plusieurs providers)
- ShippingService : calcul frais et création étiquettes
- TaxCalculator : calcul taxes selon localisation
- FraudDetectionService : détection fraude
- EmailNotificationService : emails transactionnels
- SMSNotificationService : SMS urgents
- AnalyticsService : tracking événements
- CouponService : validation codes promo
- ReviewService : gestion avis produits

# Service principal
- OrderManagementService : orchestrateur saga
```

### Fonctionnalités complexes

1. **Passer une commande (Saga Pattern)**
   - Vérifier disponibilité stock (plusieurs entrepôts)
   - Valider code promo
   - Calculer taxes selon adresse
   - Détecter fraude
   - Réserver stock
   - Traiter paiement
   - Créer expédition
   - Envoyer notifications
   - Logger analytics
   - **Compensation automatique en cas d'échec**

2. **Traiter un retour**
   - Créer étiquette retour
   - Notifier client
   - Mettre à jour inventaire après réception
   - Rembourser
   - Rétablir points fidélité

3. **Gérer les pré-commandes**
   - Produits pas encore en stock
   - Paiement partiel ou total
   - Notifications de disponibilité

### Types de Tests Doubles à utiliser

#### STUBS (pour services de calcul/consultation)
- **TaxCalculator** : retourne taux fixe selon code postal
- **ShippingService.calculate_cost()** : retourne prix fixe
- **InventoryService.check_stock()** : retourne disponibilité
- **CouponService.validate()** : retourne validité

#### MOCKS (pour vérifier comportement)
- **EmailNotificationService** : vérifier emails envoyés
- **SMSNotificationService** : vérifier SMS
- **AnalyticsService.track()** : vérifier événements loggés
- **FraudDetectionService.check()** : vérifier appel

#### SPIES (pour vérifier ET exécuter)
- **PaymentProcessor** : vérifier appels ET simuler réponse
- **InventoryService.reserve()** : vérifier ET modifier état
- **ShippingService.create_label()** : vérifier ET retourner ID

#### FAKES (implémentations simplifiées)
- **FakeInventoryDatabase** : inventaire en mémoire
- **FakePaymentGateway** : simulation paiement
- **FakeOrderRepository** : stockage commandes

### Tests à écrire (minimum 40)

#### Partie 1 : Tests avec Stubs (10 tests)
```python
# TaxCalculator (Stub)
test_calcul_taxe_france_20_pourcent()
test_calcul_taxe_dom_tom_8_5_pourcent()
test_calcul_taxe_international_zero()
test_stub_taxe_retourne_toujours_meme_valeur()

# ShippingService cost calculation (Stub)
test_frais_port_standard()
test_frais_port_express()
test_stub_shipping_ignores_weight()

# InventoryService check (Stub)
test_stub_stock_disponible()
test_stub_stock_insuffisant()
test_stub_stock_multiple_entrepots()
```

#### Partie 2 : Tests avec Mocks (12 tests)
```python
# Email notifications (Mock)
test_email_confirmation_envoye_apres_commande()
test_email_contient_numero_commande()
test_email_envoye_a_bonne_adresse()
test_pas_email_si_commande_echoue()
test_email_expedition_envoye_avec_tracking()

# Analytics tracking (Mock)
test_analytics_track_order_created_appele()
test_analytics_track_avec_bons_parametres()
test_analytics_track_order_completed()

# SMS notifications (Mock)
test_sms_envoye_pour_commande_urgente()
test_sms_non_envoye_si_option_desactivee()

# Fraud detection (Mock)
test_fraud_check_appele_avant_paiement()
test_fraud_check_avec_details_commande()
```

#### Partie 3 : Tests avec Spies (8 tests)
```python
# PaymentProcessor (Spy)
test_spy_payment_appele_et_retourne_success()
test_spy_capture_montant_exact()
test_spy_payment_avec_devise_correcte()
test_spy_payment_metadata_incluent_order_id()

# Inventory reservation (Spy)
test_spy_inventory_reserve_et_modifie_stock()
test_spy_inventory_appele_pour_chaque_item()

# Shipping label creation (Spy)
test_spy_shipping_cree_label_et_retourne_tracking()
test_spy_shipping_appele_avec_adresse_correcte()
```

#### Partie 4 : Tests de Saga avec Compensation (10 tests)
```python
# Scénarios de compensation (rollback)
test_echec_paiement_annule_reservation_stock()
test_echec_fraud_check_ne_reserve_pas_stock()
test_echec_shipping_rembourse_paiement()
test_compensation_complete_si_echec_final()
test_ordre_compensation_inverse_ordre_actions()
test_compensation_partielle_si_echec_milieu()
test_verifier_tous_mocks_appeles_dans_ordre()
test_verifier_compensation_appellee_avec_spy()
test_idempotence_des_operations()
test_saga_complete_success_tous_services_appeles()
```

#### Partie 5 : Tests avec Faker (génération de données) (10+ tests)
```python
# Utilisation intensive de Faker
test_100_commandes_clients_differents()
test_commandes_avec_adresses_internationales_variees()
test_produits_aleatoires_avec_prix_realistes()
test_codes_promo_generes_aleatoirement()
test_emails_et_phones_valides()
test_dates_livraison_coherentes()
test_performance_avec_1000_commandes()
test_noms_produits_realistes()
test_numeros_carte_credit_format_valide()
test_adresses_avec_codes_postaux_valides()
```